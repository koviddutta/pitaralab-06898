# Gelato Science v2.1 Implementation Summary

## Overview
Successfully integrated the verified gelato science guide v2.1 into the codebase. All calculations now follow the authoritative spec from `final-verified-gelato-guide_v2.1.pdf`.

## Files Created/Updated

### New Files
1. **src/lib/leightonTable.json** - Leighton freezing point depression lookup table
2. **src/lib/calc.v2.ts** - Complete v2.1 calculation engine implementing:
   - Total sugars including lactose from MSNF
   - Protein and lactose calculations (0.36× and 0.545× MSNF)
   - Sucrose Equivalents (SE) calculation
   - Leighton table lookup with clamping warnings
   - FPDT calculation (FPDSE + FPDSA)
   - Glucose syrup DE split handling
   - POD normalization (per 100g total sugars)
   - Gelato and Kulfi mode guardrails
   - Defect prevention flags
   - Troubleshooting suggestions

3. **tests/calc.v2.spec.ts** - Comprehensive test suite covering all 12 acceptance tests from the guide

### Updated Files
1. **src/lib/calc.ts** - Now uses v2.1 engine while maintaining backward compatibility

## Key Features Implemented

### 1. Total Sugars (incl. Lactose)
```
totalSugars_g = nonLactoseSugars_g + lactose_g
totalSugarsPct = 100 × totalSugars_g / totalMass_g
```
- Used for 16-22% gelato guardrail
- Used for POD normalization

### 2. Protein & Lactose from MSNF
```
protein_g = msnf_g × 0.36
lactose_g = msnf_g × 0.545
```

### 3. Sucrose Equivalents (SE)
```
SE_g = sucrose_g 
     + 1.90 × dextrose_g 
     + 1.90 × fructose_g 
     + 0.545 × MSNF_g (lactose)
     + Σ(syrup SE from DE split)
```

### 4. Glucose Syrup DE Split
```
For DE60 syrup with 40g solids:
  dextrose_g = 40 × 0.60 = 24g
  oligos_g = 40 × 0.40 = 16g
  SE = 1.9×24 + 1.0×16 = 61.6g
```

### 5. Freezing Point Depression (FPDT)
```
sucrosePer100gWater = (SE_g / water_g) × 100
FPDSE = Leighton table lookup (with clamping)
FPDSA = (MSNF_g × 2.37) / water_g
FPDT = FPDSE + FPDSA
```

**Target Windows:**
- Gelato: 2.5-3.5°C
- Kulfi: 2.0-2.5°C

### 6. POD (Normalized Sweetness Index)
```
POD_index = (100×sucrose_g + 70×dextrose_g + 120×fructose_g + 16×lactose_g) / totalSugars_g
```
Target: ~100-120 (sucrose = 100 per 100g total sugars)

## Composition Guardrails

### Gelato Mode
- Fat: 6-9% (optimal 7-8%)
- MSNF: 10-12%
- Total sugars (incl. lactose): 16-22% (hard cap ~24%)
- Total solids: 36-45%
- Water: 55-64%
- FPDT: 2.5-3.5°C

### Kulfi Mode
- Fat: 10-12%
- Protein: 6-9%
- MSNF: 18-25%
- Total solids: 38-42%
- FPDT: 2.0-2.5°C

## Defect Prevention Flags

### Automatic Warnings
- **Protein ≥ 5%**: Risk of chewiness/sandiness → lower MSNF, review stabilizer
- **Lactose ≥ 11%**: Risk of crystallization → shift to glucose syrup, reduce MSNF
- **FPDT < 2.5°C**: Too soft → lower dextrose/raise sucrose, reduce sugars, raise TS
- **FPDT > 3.5°C**: Too hard → add dextrose 2-4%, increase water within guardrails

## Testing

Run tests with:
```bash
npm run test tests/calc.v2.spec.ts
```

All 12 acceptance tests from the guide pass:
1. ✅ Composition identity
2. ✅ Protein/Lactose from MSNF
3. ✅ FP Engine integrity
4. ✅ Sugar guardrail uses totalSugars%
5. ✅ Gelato guardrails
6. ✅ Kulfi mode guardrails
7. ✅ Overrun math
8. ✅ Glucose syrup DE60 split
9. ✅ Troubleshooting triggers
10. ✅ Defect prevention flags
11. ✅ POD normalization
12. ✅ Leighton table clamping

## Usage

### Basic Usage
```typescript
import { calcMetrics } from '@/lib/calc';

const rows = [
  { ing: milk3Pct, grams: 650 },
  { ing: cream25Pct, grams: 150 },
  { ing: smp, grams: 60 },
  { ing: sucrose, grams: 120 },
  { ing: dextrose, grams: 20 }
];

const metrics = calcMetrics(rows, { evaporation_pct: 0 });

console.log('Total Sugars (incl. lactose):', metrics.totalSugars_pct);
console.log('Protein:', metrics.protein_pct);
console.log('Lactose:', metrics.lactose_pct);
console.log('FPDT:', metrics.fpdt);
console.log('POD Index:', metrics.pod_index);
console.log('Warnings:', metrics.warnings);
```

### Direct v2 Usage
```typescript
import { calcMetricsV2 } from '@/lib/calc.v2';

const metrics = calcMetricsV2(rows, { mode: 'kulfi' });
```

## Backward Compatibility

The `calcMetrics()` function maintains backward compatibility:
- All legacy fields (`sp`, `pac`, `sugars_pct`, etc.) still work
- New v2.1 fields are optional additions
- Existing components will continue to work unchanged

## Next Steps (UI Updates)

Consider updating UI components to display new v2.1 metrics:

### Display New Metrics
- **Protein %**: Show alongside MSNF
- **Lactose %**: Important for crystallization warnings
- **Total Sugars %**: More accurate than non-lactose sugars alone
- **FPDT**: More scientific than legacy PAC
- **POD Index**: Normalized sweetness (sucrose = 100)

### Show Warnings
```typescript
{metrics.warnings?.map((warning, i) => (
  <Alert key={i} variant={warning.includes('⚠️') ? 'warning' : 'info'}>
    {warning}
  </Alert>
))}
```

### Mode Selector
Add gelato/kulfi mode toggle to use appropriate guardrails

### Example Component Update
```typescript
// In your metrics display component:
<div className="metrics-grid">
  <Metric label="Total Sugars (incl. lactose)" 
          value={metrics.totalSugars_pct} 
          unit="%" 
          target="16-22" />
  
  <Metric label="Protein" 
          value={metrics.protein_pct} 
          unit="%" 
          warning={metrics.protein_pct >= 5} />
  
  <Metric label="Lactose" 
          value={metrics.lactose_pct} 
          unit="%" 
          warning={metrics.lactose_pct >= 11} />
  
  <Metric label="FPDT" 
          value={metrics.fpdt} 
          unit="°C" 
          target="2.5-3.5" />
  
  <Metric label="POD Index" 
          value={metrics.pod_index} 
          target="100-120" />
</div>

{metrics.warnings?.length > 0 && (
  <WarningsPanel warnings={metrics.warnings} />
)}
```

## Reference Documents

- Source: `final-verified-gelato-guide_v2.1.pdf`
- Leighton Table: `src/lib/leightonTable.json`
- Implementation: `src/lib/calc.v2.ts`
- Tests: `tests/calc.v2.spec.ts`

## Changelog

### v2.1 (2025-10-05)
- ✅ Total sugars now includes lactose from MSNF
- ✅ Glucose syrup DE split implemented
- ✅ Leighton table clamping with warnings
- ✅ POD normalized per 100g total sugars
- ✅ Protein and lactose calculations from MSNF
- ✅ FPDT calculation (Guelph/Leighton method)
- ✅ Gelato and Kulfi mode guardrails
- ✅ Defect prevention flags
- ✅ Troubleshooting suggestions
- ✅ Full test coverage
